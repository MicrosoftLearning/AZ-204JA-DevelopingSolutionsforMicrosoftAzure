---
lab:
    title: 'ラボ: Azure Functions を使用してタスク処理ロジックを実装する'
    az204Module: 'モジュール 02: Azure Functions の実装'
    az020Module: 'モジュール 02: Azure Functions の実装'
---

# ラボ: Azure Functions を使用してタスク処理ロジックを実装する 
# 学生課題マニュアル

## ラボ シナリオ

あなたの会社では、構成設定のためにローカルの JavaScript Object Notation (JSON) ファイルを解析するデスクトップ ソフトウェア ツールを構築しました。最新のミーティングでチームは、ローカル ファイルからではなく、URL から既定の構成設定を提供することで、アプリケーションで配布するファイルの数を減らすことにしました。あなたはチームの新しい開発者として、この問題の解決策として Microsoft Azure Functions を評価する任務を負いました。

## 目標

このラボを修了すると、次のことが可能になります。

-   Functions アプリを作成します。

-   組み込みトリガを使用して、さまざまな関数を作成する。

-   関数アプリ トリガーと入力統合を構成します。

## 課題の設定

-   推定時間: **45 分**

## 指示

### 開始する前に

#### ラボ仮想マシンへのログイン

次の認証情報を使用して、Windows 10 仮想マシン (VM) にサインインしていることを確認します。
    
-   ユーザー名: **管理者**

-   パスワード: **Pa55w.rd**

#### インストールされたアプリケーションのレビュー

Windows 10 デスクトップでタスク バーを探します。タスク バーには、この課題で使用するアプリケーションのアイコンが含まれています:

-   Microsoft Edge

-   File Explorer

-   Windows ターミナル

### 演習 1: Azure リソースの作成

#### タスク 1: Azure portal を開く

1.  Azure portal (<https://portal.azure.com>) にログインします。

1.  Azure portal に初めてログインする場合は、ポータルのツアーを提供するダイアログ ボックスが表示されます。ツアーをスキップするには、「**開始**」 を選択します。

#### タスク 2: Azure ストレージ アカウントの作成

1.  次の詳細で新規ストレージ アカウントを作成します:
    
    -   新しいリソース グループ: **サーバーレス**

    -   名前: **funcstor*[yourname]***

    -   場所: **(US) 米国東部**

    -   パフォーマンス: **Standard**

    -   アカウントの種類: **StorageV2 (汎用 v2)**

    -   レプリケーション: **ローカル冗長ストレージ (LRS)**

    -   アクセス レベル: **ホット**

    > **注**: ラボを進める前に、Azure がストレージ アカウントの作成を完了するのを待ちます。アカウントの作成時に通知が届きます。

#### タスク 3: Functions アプリの作成

1.  次の詳細で新規関数アプリを作成します:

    - 既存のリソース グループ: **サーバーレス**

    - アプリ名: **funclogic*[yourname]***

    - 公開: **コード**

    - ランタイム スタック: **.NET Core**

    -   バージョン: **3.1**

    - リージョン: **米国東部**

    - ストレージ アカウント: **funcstor*[yourname]***

    - オペレーティング システム: **Windows**

    - 計画: **消費**

    - Application Insights を有効にする: **はい**

    > **注**: ラボを進める前に、Azure が関数アプリの作成を完了するのを待ちます。アプリの作成時に通知が届きます。

#### レビュー

このラボでは、このラボで使用するすべてのリソースを作成しました。

### 演習 2: HTTP 要求によってトリガーされる関数の作成

#### タスク 1: HTTP によってトリガーされる関数を作成する

1.  このラボで以前作成した **funclogic*[yourname]*** 関数アプリにアクセスします。

1.  「**関数**」 セクションから 「**関数**」 オプションを選択します。

1.  次の設定を使用して、新しい関数を作成します:
    
    - テンプレート: **HTTP トリガー**

    - 名前: **Echo**

    - 権限レベル: **匿名**

#### タスク 2: 書き込みコードの記述

1.  「**開発者**」 セクションから 「**コード + テスト**」 オプションを選択します。 

1.  関数エディターで、関数スクリプト **run.csx** 内のサンプル コードを削除します。

1.  アプリケーションによって参照されるライブラリに対して、次の **using** ディレクティブを追加します。

    ```
    using Microsoft.AspNetCore.Mvc;
    using System.Net;
    ```

1.  型 **IActionResult** の変数を返し、*req* と *log* という名前のパラメーターとして型 **HttpRequest** と **ILogger** の変数を取る、**Run** という名前の新しい **public static** メソッドを作成します。

    ```
    public static IActionResult Run(HttpRequest req, ILogger log)
    {
    }
    ```

1.  **Run** メソッド内で、固定メッセージをログに記録します:

    ```
    log.LogInformation("Received a request");
    ```

1.  最後に、HTTP 要求の本文を HTTP 応答としてエコーします。

    ```
    return new OkObjectResult(req.Body);
    ```

1.  更新された関数コードを**保存**します。

#### タスク 3: ポータルで関数実行をテストする

1.  「**テスト/実行**」 を選択して、関数のテストを構成して実行できるポップアップ ダイアログを開きます。 

1.  「**入力**」 タブで、次の JSON 要求本文を入力します。 

    ```
    {
        "message": "Hello, World!"
    }
    ```

1.  「**実行**」 を選択して関数をテストします。

1.  テストの実行結果を確認します。結果は、元の要求本文を正確にエコーする必要があります。

#### タスク 4: 基本関数の URL の取得

1.  このラボで以前作成した **funclogic*[yourname]*** 関数アプリにアクセスします。

1.  「**URL**」 テキスト ボックスの値をコピーします。この値は、このラボの後半で使用します。

#### タスク 5: httprepl を使用して関数の実行をテストする

1.  Windows Terminal アプリケーションを開きます。

1.  **httprepl** ツールを起動し、ベースの Uniform Resource Identifier (URI) を、前にこの課題でコピーした **URL** 値に設定します。

    ```
    httprepl <function-app-url>
    ```

    > **注**: 例えば、URL が **https://funclogicstudent.azurewebsites.net** の場合、コマンドは **httprepl https://funclogicstudent.azurewebsites.net** になります。

1.  httprepl tool に表示されるエラー メッセージを監視します。このメッセージが発生するのは、ツールが API の「スキャン」に使用する Swagger 定義ファイルを検索しているためです。ロジック アプリは Swagger 定義ファイルを生成しないため、API を手動でスキャンする必要があります。

1.  ツール プロンプトで、相対 **api/echo** ディレクトリを参照します:

    ```
    cd api
    cd echo
    ```

1.  **\-\-content** オプションを使用して、数値 **3** が設定された HTTP 要求本文を送信する **post** コマンドを実行します。

    ```
    post --content 3
    ```

1.  **\-\-content** オプションを使用して、数値 **5** が設定された HTTP 要求本文を送信する **post** コマンドを実行します。

    ```
    post --content 5
    ```

1.  **\-\-content** オプションを使用して、**「Hello」** の文字列値で設定された HTTP 要求本文を送信する **post** コマンドを実行します。

    ```
    post --content "Hello"
    ```

1.  **\-\-content** オプションを使用して、JSON 値 **{"msg": "Successful"}** に設定された HTTP 要求本文に送信する **post**  コマンドを実行します。

    ```
    post --content "{"msg": "Successful"}"
    ```

1.  **httprepl** アプリケーションを終了する:

    ```
    exit
    ```

1.  現在実行中の Windows Terminal アプリケーションを閉じます。

1.	Azure portal が表示されているブラウザー ウインドウに戻ります。

#### レビュー

この演習では、HTTP POST 要求を介して送信されたコンテンツをエコーする基本的な関数を作成しました。

### エクササイズ3：スケジュールに基づいてトリガーする関数の作成

#### タスク 1: スケジュールでトリガーする関数の作成

1.  このラボで以前作成した **funclogic*[yourname]*** 関数アプリにアクセスします。

1.  次の設定を使用して、新しい関数を作成します:
    
    - テンプレート: **タイマー トリガー**

    - 名前: **定期**

    - スケジュール: **0 \*/2 \* \* \* \***

#### タスク 2: 関数の実行を確認する

1.  関数エディターに移動し、「**ログ**」 を選択し、約 2 分ごとに実行される関数の実行を確認します。各関数の実行は、ログに単純なメッセージを書き込む必要があります。

#### タスク 3: 関数の統合構成を更新する

1.  「**関数**」 ブレードで、「**開発者**」 セクションから 「**インテグレーション**」 オプションを選択します。     

1.  **タイマー** トリガーを選択します。

1.  「**トリガーの編集**」 ポップアップで、「**スケジュール**」 テキスト ボックスの値を **\*/30 \* \* \* \* \*** に変更します。

1.  トリガーへの変更を保存します。

#### タスク 4: 関数の実行を確認する

1.  「**関数**」 ブレードで、「**開発者**」 セクションから 「**コード + テスト**」 オプションを選択します。     

1.  関数エディターで、「**ログ**」 を選択します。

1.  約 30 秒ごとに実行される関数の実行を監視します。各関数の実行は、ログに単純なメッセージを書き込む必要があります。

#### レビュー

この演習では、固定スケジュールに基づいて自動的に実行される関数を作成しました。

### 演習 4: 他のサービスと統合する関数を作成する

#### タスク 1: HTTP によってトリガーされる関数を作成する

1.  このラボで以前作成した **funclogic*[yourname]*** 関数アプリにアクセスします。

1.  次の設定を使用して、新しい関数を作成します:
    
    - テンプレート: **HTTP トリガー**

    - 名前: **GetSettingInfo**

    - 権限レベル: **匿名**

#### タスク 2: サンプル コンテンツをアップロードする

1.  このラボで前に作成した **funcstor*[yourname]*** ストレージ アカウントにアクセスします。

1.  「**BLOB サービス**」 セクションで 「**コンテナー**」 を選択し、次の設定で新しいコンテナーを作成します:
    
    - 名前: **content**

    - パブリック アクセス レベル: **非公開 (匿名アクセスなし)**

1.  最近作成した **content** コンテナーを選択します。
    
1.  **content** コンテナーで、「**アップロード**」 を選択して課題の VM の **Allfiles (F): \\Allfiles\\Labs\\02\\Starter** フォルダーに **settings.json** ファイルをアップロードします。

    > **注**: 「**ファイルが既に存在する場合は上書きする**」 オプションを有効にすることをお勧めします。 

#### タスク 3: HTTP トリガー関数を構成する

1.  このラボで以前作成した **funclogic*[yourname]*** 関数アプリにアクセスします。

1.  「**App Service**」 ブレードで、**GetSettingInfo** 関数の 「**インテグレーション**」 ウィンドウを見つけて開きます。

1.  「**インテグレーション**」 セクションで、次の構成を使用してタイプ **Azure Blob Storage** の新しい**入力**を作成します。

    -   BLOB パラメーター名: **json**

    -   パス: **content/settings.json**

    -   ストレージ アカウントの接続: **AzureWebJobsStorage**

1.  「**統合**」 セクションに戻り、既存の **HTTP トリガー**を選択します。

1.  **HTTP**トリガーを更新してから、次の構成で更新します。 

    -   リクエスト パラメーター名: **request**

    -   選択された HTTP メソッド: **GET**

#### タスク 4: 書き込みコードの記述

1.  「**関数**」 ブレードで、「**開発者**」 セクションから 「**コード + テスト**」 オプションを選択します。     

1.  関数エディターで、サンプルの **run.csx** 関数スクリプトを削除します。

1.  アプリケーションによって参照されるライブラリに対して、次の **using** ディレクティブを追加します。

    ```
    using Microsoft.AspNetCore.Mvc;
    using System.Net;
    ```

1.  タイプ **IActionResult** の変数を返し、タイプ **HttpRequest** と **string** の変数を *request* と *json* という名前のパラメーターとして取る、**Run** という名前の新しい **public static** メソッドを作成します。

    ```
    public static IActionResult Run(HttpRequest request, string json)
    {
    }
    ```

1.  **Run** メソッド内で、*json* パラメーターの内容を関数の HTTP 応答として返します。

    ```
    return new OkObjectResult(json);
    ```

1.  更新された関数コードを**保存**します。

#### タスク 5: 関数実行のテスト

1.  Windows Terminal アプリケーションを開きます。

1.  **httprepl** ツールを起動し、このラボで前にコピーした URL 値にベース URI を設定します。

    ```
    httprepl <function-app-url>
    ```

    > **注**: 例えば、URL が **https://funclogicstudent.azurewebsites.net** の場合、コマンドは **httprepl https://funclogicstudent.azurewebsites.net** になります。

1.  ツール プロンプトで、相対 **api/getsettinginfo** エンドポイントを参照します。

    ```
    cd api
    cd getsettinginfo
    ```

1.  現在のエンドポイントに対して **get** コマンドを実行します。

    ```
    get
    ```

1.  関数アプリからの応答の JSON コンテンツを確認します。

1.  **httprepl** アプリケーションを終了する:

    ```
    exit
    ```

1.  現在実行中の Windows Terminal アプリケーションを閉じます。

1.	Azure portal が表示されているブラウザー ウインドウに戻ります。

#### レビュー

このエクササイズでは、ストレージ内の JSON ファイルの内容を返す関数を作成しました。

### エクササイズ 5: サブスクリプションのクリーンアップ 

#### タスク 1: Azure Cloud Shell を開き、リソース グループを一覧表示する

1.  ポータルで、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。

1.  Cloud Shellがまだ構成されていない場合は、既定の設定を使用して Bash のシェルを構成します。

#### タスク 2: リソース グループの削除

1.  次のコマンドを入力し、Enter キーを押して **Serverless** リソース グループを削除します。

    ```
    az group delete --name Serverless --no-wait --yes
    ```
    
1.  ポータルの Cloud Shell ペインを閉じます。

#### タスク 3: アクティブなアプリケーションを閉じる

1.     現在実行中の Microsoft Edge アプリケーションを閉じます。

#### レビュー

この実習では、この演習で使用したリソース グループを削除してサブスクリプションをクリーンアップしました。
